#!/usr/bin/env bash
set -e

# Setup script using uv for faster installation
# Falls back to pip if uv is not available

cd "$(dirname "$0")/.."

# Check platform
if [[ $(uname -m) != "arm64" ]]; then
    echo "Warning: This package requires Apple Silicon (M1/M2/M3/M4)"
    echo "Detected platform: $(uname -m)"
    exit 1
fi

# Parse arguments
DEV_FLAG=""
ZEROCONF_FLAG=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --dev)
            DEV_FLAG="[dev]"
            shift
            ;;
        --zeroconf)
            ZEROCONF_FLAG="[zeroconf]"
            shift
            ;;
        *)
            echo "Unknown option: $1"
            echo "Usage: $0 [--dev] [--zeroconf]"
            exit 1
            ;;
    esac
done

# Combine extras
EXTRAS="${DEV_FLAG}${ZEROCONF_FLAG}"
if [[ -n "$DEV_FLAG" && -n "$ZEROCONF_FLAG" ]]; then
    EXTRAS="[dev,zeroconf]"
fi

# Try to use uv first
if command -v uv &> /dev/null; then
    echo "Using uv for fast installation..."

    # Create venv if it doesn't exist
    if [[ ! -d .venv ]]; then
        uv venv
    fi

    # Install with uv
    uv pip install -e ".${EXTRAS}"

    echo ""
    echo "Installation complete with uv!"
else
    # Fallback to traditional pip
    echo "uv not found, using pip..."
    echo "Install uv for faster setup: curl -LsSf https://astral.sh/uv/install.sh | sh"
    echo ""

    # Create venv
    if [[ ! -d .venv ]]; then
        python3 -m venv .venv
    fi

    # Activate and install
    source .venv/bin/activate
    pip install --upgrade pip setuptools wheel
    pip install -e ".${EXTRAS}"

    echo ""
    echo "Installation complete with pip!"
fi

echo ""
echo "To activate the environment:"
echo "  source .venv/bin/activate"
echo ""
echo "To run wyoming-qwen:"
echo "  wyoming-qwen --speaker Ryan --data-dir /tmp/wyoming-qwen --uri tcp://0.0.0.0:10200"
